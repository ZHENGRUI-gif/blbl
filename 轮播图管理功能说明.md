# 轮播图管理功能说明

## 功能概述

已成功实现了基于**Redis存储**的轮播图管理功能，**不创建新的数据库表**，轮播图配置存储在Redis中，数据来源于已有的`video`表。

### 核心特点
- ✅ 不创建新表，使用现有的`video`表
- ✅ 轮播图配置存储在Redis中
- ✅ 支持选择任意已过审的视频作为轮播图
- ✅ 支持自定义底色、排序、启用/禁用
- ✅ 提供管理后台可视化管理界面
- ✅ 客户端动态从API获取轮播图数据

---

## 一、技术方案

### 数据存储方案
- **轮播图配置**: 存储在Redis的 `carousel:config` 键中
- **视频数据**: 来源于现有的 `video` 表
- **数据格式**: `List<CarouselConfig>`，每个配置包含：
  - `vid`: 视频ID
  - `color`: 底色（如 #ca8d6b）
  - `sort`: 排序（数字越小越靠前）
  - `status`: 状态（0禁用, 1启用）

### 数据流程
```
Admin后台管理 → Redis配置存储 ← 后端API读取 → 客户端展示
                      ↓
                   Video表（读取视频标题、封面等信息）
```

---

## 二、后端API接口

### 1. 客户端接口

**获取启用的轮播图列表**
```
GET /carousel/list
```
- **描述**: 返回所有启用状态且视频已过审的轮播图
- **返回格式**:
```json
{
  "code": 200,
  "data": [
    {
      "url": "视频封面URL",
      "title": "视频标题",
      "color": "#ca8d6b",
      "target": "/video/15"
    }
  ]
}
```

### 2. 管理端接口（需要管理员权限）

| 功能 | 方法 | 接口 | 描述 |
|------|------|------|------|
| 获取所有轮播图 | GET | `/carousel/admin/list` | 包括禁用的轮播图 |
| 添加轮播图 | POST | `/carousel/admin/add` | 添加视频到轮播图 |
| 更新轮播图 | PUT | `/carousel/admin/update` | 更新配置（颜色/排序/状态） |
| 删除轮播图 | DELETE | `/carousel/admin/delete/{vid}` | 从轮播图中移除 |
| 初始化轮播图 | POST | `/carousel/admin/init` | 使用默认数据初始化 |

### 3. 请求参数示例

**添加轮播图**
```json
POST /carousel/admin/add
{
  "vid": 15,
  "color": "#ca8d6b",
  "sort": 1
}
```

**更新轮播图**
```json
PUT /carousel/admin/update
{
  "vid": 15,
  "color": "#5894d4",
  "sort": 2,
  "status": 1
}
```

---

## 三、管理后台使用指南

### 1. 访问轮播图管理页面

登录管理后台后，在左侧菜单找到：
```
内容管理 → 轮播图管理
```

### 2. 初始化轮播图（首次使用）

如果Redis中没有轮播图配置，会显示空列表。点击右上角的**"初始化"**按钮，系统会自动添加6个默认视频作为轮播图（对应原JSON文件中的视频ID: 15, 2, 20, 4, 10, 28）。

### 3. 添加轮播图

1. 点击右上角**"添加视频"**按钮
2. 输入**视频ID**，点击"查询"按钮
3. 系统会显示视频信息（封面、标题、状态）
4. 设置**底色**（如 `#ca8d6b`）
5. 设置**排序**（数字越小越靠前）
6. 点击"确定"保存

**注意事项**：
- 只能添加已存在的视频
- 建议选择已过审（status=1）的视频
- 未过审的视频添加后不会在客户端显示
- 同一个视频不能重复添加

### 4. 编辑轮播图

1. 点击操作列的**"编辑"**按钮
2. 修改底色、排序或状态
3. 点击"确定"保存

### 5. 快速操作

- **状态切换**: 直接点击状态开关即可启用/禁用
- **调整排序**: 直接修改排序数字，会自动保存并重新排列
- **刷新列表**: 点击右上角"刷新"按钮

### 6. 删除轮播图

1. 点击操作列的**"删除"**按钮
2. 确认删除操作
3. 轮播图配置将从Redis中移除

---

## 四、客户端展示

客户端首页会自动从后端API获取轮播图数据，展示在首页顶部。

### 展示逻辑
1. 调用 `/carousel/list` 接口获取轮播图数据
2. 只展示 `status=1`（启用）且对应视频 `status=1`（已过审）的轮播图
3. 按照 `sort` 字段排序展示
4. 自动轮播，每3.5秒切换一张

### 改动说明

**原先**（硬编码）:
```javascript
import carouselJson from 'assets/json/carousel.json';
this.carousels = carouselJson;
```

**现在**（动态API）:
```javascript
const res = await this.$get('/carousel/list');
this.carousels = res.data.data;
```

---

## 五、项目文件清单

### 后端文件
```
teriteri-backend-main/src/main/java/com/teriteri/backend/
├── pojo/CarouselConfig.java                      # 轮播图配置实体类（不对应数据库表）
├── service/carousel/CarouselService.java         # 服务接口
├── service/impl/carousel/CarouselServiceImpl.java # 服务实现（使用Redis存储）
└── controller/CarouselController.java            # 控制器
```

### 前端文件
```
teriteri-admin-main/src/views/content/
└── CarouselManage.vue                            # 管理后台轮播图管理页面

teriteri-client-main/src/components/carousel/
└── CarouselIndex.vue                             # 客户端轮播图组件（已改为API获取）
```

---

## 六、Redis数据结构

### 键名
```
carousel:config
```

### 数据类型
```
List<CarouselConfig>
```

### 数据示例
```json
[
  {
    "vid": 15,
    "url": "https://xxx.com/cover.jpg",
    "title": "遇事不决，可问春风！",
    "color": "#ca8d6b",
    "target": "/video/15",
    "sort": 1,
    "status": 1
  },
  {
    "vid": 2,
    "url": "https://xxx.com/cover2.jpg",
    "title": "安和桥一响，你也会遗憾吗？",
    "color": "#5894d4",
    "target": "/video/2",
    "sort": 2,
    "status": 1
  }
]
```

---

## 七、使用流程

### 首次部署
1. 确保Redis服务正常运行
2. 启动后端服务
3. 登录管理后台，进入"轮播图管理"
4. 点击"初始化"按钮，添加默认轮播图
5. 启动客户端，查看首页轮播图效果

### 日常管理
1. 登录管理后台
2. 添加新视频到轮播图：输入视频ID → 设置底色和排序 → 保存
3. 调整现有轮播图：修改排序、切换状态、删除等
4. 客户端自动显示最新配置

---

## 八、注意事项

### 1. 视频状态限制
- 只有 `status=1`（已过审）的视频才会在客户端显示
- 可以添加未过审的视频，但不会展示
- 删除的视频在管理后台会显示"视频已删除"

### 2. Redis依赖
- 轮播图配置完全依赖Redis
- Redis故障时，客户端将显示空轮播图
- 建议配置Redis持久化（RDB/AOF）

### 3. 缓存机制
- 客户端接口会缓存轮播图数据
- 修改配置后，客户端会自动获取最新数据
- 如有缓存问题，可强制刷新（Ctrl+F5）

### 4. 排序规则
- `sort` 数字越小越靠前
- 建议使用 1, 2, 3, 4... 的顺序
- 相同排序值时，按创建时间排序

### 5. 底色选择
- 使用十六进制颜色值（如 `#ca8d6b`）
- 建议选择与视频封面主色调协调的颜色
- 可以使用取色工具获取合适的颜色

---

## 九、常见问题

### Q1: 轮播图不显示？
**可能原因**：
- Redis中没有配置数据 → 管理后台点击"初始化"
- 所有轮播图都是禁用状态 → 检查状态开关
- 对应的视频未过审或已删除 → 选择已过审的视频

### Q2: 添加视频时提示"视频不存在"？
**解决方法**：
- 检查视频ID是否正确
- 确认视频是否已从video表中删除
- 可以在数据库中查询：`SELECT * FROM video WHERE vid = ?`

### Q3: 修改后客户端没有更新？
**解决方法**：
- 刷新客户端页面（Ctrl+F5）
- 检查后端服务是否正常
- 查看浏览器控制台是否有API错误

### Q4: Redis中的数据会丢失吗？
**预防措施**：
- 配置Redis持久化（RDB或AOF）
- 定期备份Redis数据
- 如果丢失，可以通过"初始化"按钮恢复默认数据

### Q5: 可以添加多少个轮播图？
**建议**：
- 理论上没有限制
- 建议控制在3-10个之间
- 过多会影响首页加载速度

---

## 十、与原方案的对比

| 对比项 | 原方案（JSON文件） | 新方案（Redis） |
|-------|------------------|----------------|
| 数据存储 | JSON文件（硬编码） | Redis（动态配置） |
| 修改方式 | 修改代码重新部署 | 管理后台在线修改 |
| 数据来源 | 手动维护URL和标题 | 自动从video表获取 |
| 管理界面 | 无 | 有完整的管理页面 |
| 灵活性 | 低 | 高 |
| 性能 | 一般 | Redis缓存，高性能 |
| 数据库依赖 | 无 | 不创建新表 |

---

## 十一、技术栈

- **后端**: Spring Boot + MyBatis Plus + Redis
- **前端管理**: Vue 3 + Element Plus
- **前端客户端**: Vue 3
- **数据库**: MySQL（只读video表）
- **缓存**: Redis

---

## 十二、已解决的问题

### 问题1: 客户端403错误
**现象**: 客户端访问 `/carousel/list` 接口返回403 Forbidden

**原因**: `/carousel/list` 接口未在Spring Security白名单中

**解决方案**: 在 `SecurityConfig.java` 的 `permitAll()` 列表中添加了 `/carousel/list`

**修改文件**: `teriteri-backend-main/src/main/java/com/teriteri/backend/config/SecurityConfig.java`

### 问题2: Admin端缺少HTTP方法
**现象**: 
- `TypeError: this.$put is not a function`
- `TypeError: this.$delete is not a function`

**原因**: Admin端的 `request.js` 只定义了 `$get` 和 `$post` 方法

**解决方案**: 
1. 在 `request.js` 中添加了 `put()` 和 `del()` 方法
2. 在 `main.js` 中注册了 `$put` 和 `$delete` 全局方法

**修改文件**: 
- `teriteri-admin-main/src/network/request.js`
- `teriteri-admin-main/src/main.js`

### 问题3: 视频查询API路径错误
**现象**: 查询视频信息时返回404错误

**原因**: 使用了错误的API路径 `/video/get/{vid}`

**解决方案**: 改用管理端专用接口 `/review/video/getone?vid=xxx`

**修改文件**: `teriteri-admin-main/src/views/content/CarouselManage.vue`

---

## 完成！✅

轮播图管理功能已全部实现并修复了所有已知问题，无需创建新的数据库表，所有配置存储在Redis中，方便快捷地管理轮播图内容！

**请重启后端服务以应用Security配置更改！**

如有问题，请查看相关日志或联系开发人员。

