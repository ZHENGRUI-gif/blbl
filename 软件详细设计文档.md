# BLBL 视频分享平台软件详细设计文档

## 文档信息

| 项目名称 | BLBL视频分享平台 |
|---------|----------------|
| 文档版本 | 1.0 |
| 编写日期 | 2024年 |
| 编写人员 | 开发团队 |
| 文档类型 | 详细设计文档 |

---

## 1. 引言

### 1.1 编写目的

本文档旨在描述BLBL视频分享平台的详细设计，为开发人员提供详细的开发指导，确保项目按照统一的设计标准实现。

### 1.2 项目背景

BLBL是一个类似Bilibili的视频分享平台，支持视频上传、播放、评论、弹幕、收藏等核心功能，为内容创作者和观众提供互动交流的平台。

### 1.3 技术架构

**后端技术栈：**
- Spring Boot 2.7.15
- MyBatis Plus 3.5.2
- MySQL 8.0
- Redis
- Elasticsearch 7.17
- RabbitMQ
- 阿里云OSS
- JWT认证
- Netty (WebSocket)

**前端技术栈：**
- Vue.js
- Element UI
- Axios

### 1.4 参考资料

- Spring Boot官方文档
- MyBatis Plus官方文档
- Vue.js官方文档

---

## 2. 系统总体架构设计

### 2.1 系统架构图

```startuml
@startuml
!theme plain
skinparam componentStyle rectangle

package "客户端层" {
  component [Vue.js客户端] as Client
  component [Vue.js管理后台] as Admin
}

package "接口层" {
  component [Controller层] as Controller
  component [WebSocket] as WebSocket
}

package "业务逻辑层" {
  component [Service层] as Service
  component [业务服务模块] as Business
}

package "数据访问层" {
  component [Mapper层] as Mapper
  component [缓存层] as Cache
}

package "数据存储层" {
  database "MySQL" as MySQL
  database "Redis" as Redis
  database "Elasticsearch" as ES
  database "阿里云OSS" as OSS
  queue "RabbitMQ" as MQ
}

package "外部服务" {
  component [JWT认证] as JWT
  component [安全框架] as Security
}

Client --> Controller : HTTP请求
Admin --> Controller : HTTP请求
Client --> WebSocket : WebSocket连接

Controller --> Service : 调用服务
Controller --> JWT : 认证验证
Controller --> Security : 权限控制

Service --> Mapper : 数据访问
Service --> Cache : 缓存读写
Service --> Business : 业务处理
Service --> MQ : 异步消息

Mapper --> MySQL : SQL查询
Cache --> Redis : 缓存操作
Business --> ES : 全文搜索
Business --> OSS : 文件存储

@enduml
```

### 2.2 系统模块划分

系统主要分为以下几个模块：

1. **用户管理模块** - 用户注册、登录、信息管理
2. **视频管理模块** - 视频上传、审核、播放、统计
3. **评论模块** - 评论发布、查看、回复
4. **互动模块** - 点赞、投币、收藏、关注
5. **消息模块** - 私信、通知、系统消息
6. **搜索模块** - 视频搜索、用户搜索
7. **弹幕模块** - 弹幕发送、显示
8. **数据统计模块** - 用户数据、视频数据统计

### 2.3 数据架构设计

```startuml
@startuml
entity "用户表(User)" as User {
  * uid : INT (PK, 自增)
  username : VARCHAR
  password : VARCHAR
  nickname : VARCHAR
  avatar : VARCHAR
  --
  gender : INT
  exp : INT
  coin : DOUBLE
  vip : INT
  role : INT
}

entity "视频表(Video)" as Video {
  * vid : INT (PK, 自增)
  * uid : INT (FK)
  title : VARCHAR
  --
  coverUrl : VARCHAR
  videoUrl : VARCHAR
  status : INT
  uploadDate : DATETIME
}

entity "收藏夹表(Favorite)" as Favorite {
  * fid : INT (PK, 自增)
  * uid : INT (FK)
  --
  title : VARCHAR
  description : VARCHAR
  visible : INT
  count : INT
}

entity "收藏关系表(FavoriteVideo)" as FV {
  * vid : INT (FK)
  * fid : INT (FK)
  --
  addDate : DATETIME
}

entity "评论表(Comment)" as Comment {
  * id : INT (PK, 自增)
  * vid : INT (FK)
  * uid : INT (FK)
  --
  content : VARCHAR
  rootId : INT
  parentId : INT
  love : INT
}

entity "关注表(Follow)" as Follow {
  * uid : INT (FK)
  * followId : INT (FK)
  --
  followDate : DATETIME
}

entity "点赞表(VideoStats)" as Stats {
  * vid : INT (FK)
  * uid : INT (FK)
  --
  isGood : BOOLEAN
  isCoin : BOOLEAN
}

User ||--o{ Video : "投稿"
User ||--o{ Favorite : "拥有"
User ||--o{ Comment : "发布"
Video ||--o{ FavoriteVideo : "被收藏"
Video ||--o{ Comment : "拥有"
Video ||--o{ Stats : "统计"
User ||--o{ Follow : "关注/被关注"

@enduml
```

---

## 3. 核心模块详细设计

### 3.1 用户管理模块

#### 3.1.1 模块概述

用户管理模块负责处理用户的注册、登录、认证、信息管理等功能。

#### 3.1.2 类设计

**UserAccountController**
- 路径：`com.teriteri.backend.controller.UserAccountController`
- 职责：处理用户账户相关的HTTP请求

**UserAccountService**
- 路径：`com.teriteri.backend.service.user.UserAccountService`
- 职责：实现用户账户相关的业务逻辑

**UserAccountServiceImpl**
- 路径：`com.teriteri.backend.service.impl.user.UserAccountServiceImpl`
- 职责：用户账户服务接口的具体实现

#### 3.1.3 接口设计

**用户注册接口**
```java
POST /user/account/register
请求参数：
{
  "username": "用户名",
  "password": "密码",
  "confirmedPassword": "确认密码"
}
响应：
{
  "code": 200,
  "message": "注册成功",
  "data": null
}
```

**用户登录接口**
```java
POST /user/account/login
请求参数：
{
  "username": "用户名",
  "password": "密码"
}
响应：
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "JWT令牌",
    "user": {...}
  }
}
```

#### 3.1.4 流程设计

**用户注册流程图**

```startuml
@startuml
start
:用户提交注册信息;
if (用户名是否存在?) then (存在)
  :返回"用户名已存在";
  stop
endif

if (密码与确认密码是否一致?) then (不一致)
  :返回"密码不一致";
  stop
endif

:生成用户对象;
:密码加密;
:保存到数据库;
:初始化用户数据(经验值、硬币等);
:返回注册成功;

stop
@enduml
```

**用户登录流程图**

```startuml
@startuml
start
:用户提交登录信息;
:查询数据库验证用户名;
if (用户不存在?) then (是)
  :返回"用户名不存在";
  stop
endif

if (密码错误?) then (是)
  :返回"密码错误";
  stop
endif

if (账户被封禁?) then (是)
  :返回"账户已被封禁";
  stop
endif

:生成JWT令牌;
:将用户信息存入Redis;
:返回登录成功及令牌;

stop
@enduml
```

### 3.2 视频管理模块

#### 3.2.1 模块概述

视频管理模块负责视频的上传、审核、播放、统计等功能。

#### 3.2.2 类设计

**VideoController**
- 路径：`com.teriteri.backend.controller.VideoController`
- 职责：处理视频相关的HTTP请求

**VideoService**
- 路径：`com.teriteri.backend.service.video.VideoService`
- 职责：实现视频相关的业务逻辑

**VideoMapper**
- 路径：`com.teriteri.backend.mapper.VideoMapper`
- 职责：视频数据访问

#### 3.2.3 接口设计

**视频上传接口**
```java
POST /video/upload
请求参数：MultipartFile (视频文件)
响应：
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "vid": "视频ID",
    "videoUrl": "视频URL"
  }
}
```

**获取视频信息接口**
```java
GET /video/getone?vid={视频ID}
响应：
{
  "code": 200,
  "message": "成功",
  "data": {
    "video": {...},
    "stats": {...},
    "author": {...}
  }
}
```

#### 3.2.4 流程设计

**视频上传流程图**

```startuml
@startuml
start
:用户选择视频文件;
:前端分片上传到后端;
:后端接收分片并保存;
if (所有分片上传完成?) then (否)
  :返回"分片上传成功";
  stop
endif

:合并所有分片;
:生成视频封面;
:上传到阿里云OSS;
:保存视频信息到数据库;
:更新Redis缓存;
:返回上传成功;

stop
@enduml
```

**视频审核流程图**

```startuml
@startuml
start
:管理员查看待审核视频;
if (视频内容合规?) then (是)
  :设置status=1(通过);
  :更新Redis状态;
  :通知投稿者审核通过;
  stop
else (否)
  :设置status=2(不通过);
  :发送整改通知;
  stop
endif

@enduml
```

### 3.3 收藏模块

#### 3.3.1 模块概述

收藏模块允许用户创建收藏夹并收藏视频。

#### 3.3.2 类设计

**FavoriteController**
- 路径：`com.teriteri.backend.controller.FavoriteController`
- 职责：处理收藏相关的HTTP请求

**FavoriteService**
- 路径：`com.teriteri.backend.service.video.FavoriteService`
- 职责：实现收藏相关的业务逻辑

**FavoriteVideoController**
- 路径：`com.teriteri.backend.controller.FavoriteVideoController`
- 职责：处理视频收藏操作

#### 3.3.3 接口设计

**创建收藏夹接口**
```java
POST /favorite/create
请求参数：
{
  "title": "收藏夹标题",
  "desc": "收藏夹描述",
  "visible": 0或1
}
响应：
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "fid": "收藏夹ID"
  }
}
```

**添加视频到收藏夹接口**
```java
POST /favorite-video/add
请求参数：
{
  "vid": "视频ID",
  "fid": "收藏夹ID"
}
响应：
{
  "code": 200,
  "message": "收藏成功",
  "data": null
}
```

#### 3.3.4 流程设计

**收藏视频流程图**

```startuml
@startuml
start
if (点击收藏?) then (是)
  :用户选择目标收藏夹;
  if (收藏夹是否存在?) then (否)
    :创建新收藏夹;
  endif
  
  :查询是否已收藏;
  if (已收藏?) then (是)
    :返回"已收藏";
    stop
  endif
  
  :写入收藏关系表(FavoriteVideo);
  :更新收藏夹视频数量(count++);
  :更新Redis缓存;
  :返回"收藏成功";
endif

if (查看收藏夹?) then (是)
  :查询收藏夹信息;
  :查询收藏的视频列表;
  :整合数据并返回;
endif

if (取消收藏?) then (是)
  :删除收藏关系表记录;
  :更新收藏夹视频数量(count--);
  :更新Redis缓存;
  :返回"已取消收藏";
endif

stop
@enduml
```

### 3.4 评论模块

#### 3.4.1 模块概述

评论模块支持用户对视频发表评论、回复评论等功能。

#### 3.4.2 类设计

**CommentController**
- 路径：`com.teriteri.backend.controller.CommentController`
- 职责：处理评论相关的HTTP请求

**CommentService**
- 路径：`com.teriteri.backend.service.comment.CommentService`
- 职责：实现评论相关的业务逻辑

**CommentMapper**
- 路径：`com.teriteri.backend.mapper.CommentMapper`
- 职责：评论数据访问

#### 3.4.3 接口设计

**发表评论接口**
```java
POST /comment/add
请求参数：
{
  "vid": "视频ID",
  "rootId": "根评论ID",
  "parentId": "父评论ID",
  "toUserId": "被回复用户ID",
  "content": "评论内容"
}
响应：
{
  "code": 200,
  "message": "发表成功",
  "data": CommentTree
}
```

**获取评论树接口**
```java
GET /comment/get?vid={视频ID}&offset={偏移量}&type={排序类型}
响应：
{
  "code": 200,
  "message": "成功",
  "data": {
    "more": true/false,
    "comments": [...]
  }
}
```

#### 3.4.4 流程设计

**评论发布流程图**

```startuml
@startuml
start
:用户输入评论内容;
if (是根评论?) then (是)
  :创建新评论记录;
  :rootId设为自身ID;
else (是回复评论)
  if (是回复根评论?) then (是)
    :rootId设为根评论ID;
    :parentId设为空;
  else (是回复子评论)
    :rootId设为根评论ID;
    :parentId设为被回复评论ID;
  endif
endif

:保存评论到数据库;
:更新视频评论数;
:添加到Redis Sorted Set;
:通知被回复用户;
:返回评论树;

stop
@enduml
```

### 3.5 互动模块

#### 3.5.1 模块概述

互动模块包括点赞、投币、关注等用户交互功能。

#### 3.5.2 接口设计

**点赞/投币接口**
```java
POST /video/stats/like 或 /video/stats/coin
请求参数：
{
  "vid": "视频ID",
  "isGood": true/false,
  "isCoin": true/false
}
响应：
{
  "code": 200,
  "message": "操作成功",
  "data": {...}
}
```

#### 3.5.3 流程设计

**点赞/投币流程图**

```startuml
@startuml
start
:用户点击点赞/投币;
:查询Redis是否已操作;
if (已操作?) then (是)
  :取消操作;
  :减少统计数据;
else (否)
  :执行操作;
  :增加统计数据;
endif

:更新Redis缓存;
:更新数据库;
:推送消息给UP主;

stop
@enduml
```

### 3.6 弹幕模块

#### 3.6.1 模块概述

弹幕模块通过WebSocket实现实时弹幕功能。

#### 3.6.2 类设计

**DanmuController**
- 路径：`com.teriteri.backend.controller.DanmuController`
- 职责：处理弹幕相关的HTTP请求

**DanmuWebSocketServer**
- 路径：`com.teriteri.backend.component.danmu.DanmuWebSocketServer`
- 职责：WebSocket服务器，处理弹幕实时推送

**DanmuService**
- 路径：`com.teriteri.backend.service.danmu.DanmuService`
- 职责：实现弹幕相关的业务逻辑

#### 3.6.3 流程设计

**弹幕发送流程图**

```startuml
@startuml
start
:用户观看视频;
:发送弹幕内容;

:保存弹幕到数据库;
:解析弹幕参数(颜色、位置等);
:广播给同房间内所有用户;

:返回发送成功;
stop
@enduml
```

### 3.7 搜索模块

#### 3.7.1 模块概述

搜索模块使用Elasticsearch实现全文搜索功能。

#### 3.7.2 类设计

**SearchController**
- 路径：`com.teriteri.backend.controller.SearchController`
- 职责：处理搜索相关的HTTP请求

**SearchService**
- 路径：`com.teriteri.backend.service.search.SearchService`
- 职责：实现搜索相关的业务逻辑

#### 3.7.3 接口设计

**视频搜索接口**
```java
GET /search/video?keyword={关键词}&page={页码}&quantity={数量}
响应：
{
  "code": 200,
  "message": "成功",
  "data": {
    "count": "结果总数",
    "videos": [...]
  }
}
```

#### 3.7.4 流程设计

**搜索流程图**

```startuml
@startuml
start
:用户输入搜索关键词;
:调用Elasticsearch搜索API;
:获取搜索结果;
:补充视频统计数据;
:返回结果列表;

stop
@enduml
```

### 3.8 消息模块

#### 3.8.1 模块概述

消息模块包括私信、系统通知等功能。

#### 3.8.2 类设计

**ChatController**
- 路径：`com.teriteri.backend.controller.ChatController`
- 职责：处理私信相关的HTTP请求

**SystemMessageController**
- 路径：`com.teriteri.backend.controller.SystemMessageController`
- 职责：处理系统消息

**IMServer**
- 路径：`com.teriteri.backend.im.IMServer`
- 职责：即时通讯服务器

#### 3.8.3 流程设计

**私信流程图**

```startuml
@startuml
start
:用户A发送消息给用户B;
:保存消息到数据库;

if (用户B在线?) then (是)
  :通过WebSocket实时推送;
else (否)
  :标记为未读消息;
endif

:返回发送成功;
stop
@enduml
```

---

## 4. 数据库设计

### 4.1 主要数据表

#### 4.1.1 用户表(User)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | INT | 主键，自增 |
| username | VARCHAR | 用户名，唯一 |
| password | VARCHAR | 密码(加密) |
| nickname | VARCHAR | 昵称 |
| avatar | VARCHAR | 头像URL |
| background | VARCHAR | 背景图片URL |
| gender | INT | 性别(0女/1男/2无) |
| description | VARCHAR | 个人简介 |
| exp | INT | 经验值 |
| coin | DOUBLE | 硬币数 |
| vip | INT | 会员等级 |
| state | INT | 状态(0正常/1封禁/2注销) |
| role | INT | 角色(0用户/1管理员/2超级管理员) |
| auth | INT | 认证状态 |
| authMsg | VARCHAR | 认证信息 |
| location | VARCHAR | 所在地 |
| createDate | DATETIME | 创建时间 |
| deleteDate | DATETIME | 删除时间 |

#### 4.1.2 视频表(Video)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| vid | INT | 主键，自增 |
| uid | INT | 投稿者ID |
| title | VARCHAR | 标题 |
| type | INT | 类型 |
| auth | INT | 权限 |
| duration | DOUBLE | 时长(秒) |
| mcId | VARCHAR | 主分类ID |
| scId | VARCHAR | 子分类ID |
| tags | VARCHAR | 标签 |
| descr | VARCHAR | 描述 |
| coverUrl | VARCHAR | 封面URL |
| videoUrl | VARCHAR | 视频URL |
| status | INT | 状态(0审核中/1通过/2不通过/3删除) |
| uploadDate | DATETIME | 投稿时间 |
| deleteDate | DATETIME | 删除时间 |

#### 4.1.3 评论表(Comment)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| vid | INT | 视频ID |
| uid | INT | 评论者ID |
| rootId | INT | 根评论ID |
| parentId | INT | 父评论ID |
| toUserId | INT | 被回复用户ID |
| content | VARCHAR | 评论内容 |
| love | INT | 点赞数 |
| bad | INT | 点踩数 |
| createTime | DATETIME | 创建时间 |
| isTop | INT | 是否置顶 |
| isDeleted | INT | 是否删除 |

#### 4.1.4 收藏夹表(Favorite)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| fid | INT | 主键，自增 |
| uid | INT | 所属用户ID |
| type | INT | 类型(1默认/2自定义) |
| visible | INT | 是否公开(0隐藏/1公开) |
| cover | VARCHAR | 封面URL |
| title | VARCHAR | 标题 |
| description | VARCHAR | 描述 |
| count | INT | 视频数量 |
| isDelete | INT | 是否删除 |

#### 4.1.5 收藏关系表(FavoriteVideo)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| vid | INT | 视频ID |
| fid | INT | 收藏夹ID |
| addDate | DATETIME | 添加时间 |

#### 4.1.6 视频统计表(VideoStats)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| vid | INT | 视频ID |
| uid | INT | 用户ID |
| isGood | BOOLEAN | 是否点赞 |
| isCoin | BOOLEAN | 是否投币 |
| playDate | DATETIME | 播放时间 |

#### 4.1.7 弹幕表(Danmu)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| vid | INT | 视频ID |
| uid | INT | 用户ID |
| content | VARCHAR | 弹幕内容 |
| time | DOUBLE | 时间点(秒) |
| color | VARCHAR | 颜色 |
| type | INT | 类型 |
| fontSize | INT | 字体大小 |
| createDate | DATETIME | 创建时间 |

#### 4.1.8 关注表(Follow)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| uid | INT | 用户ID |
| followId | INT | 被关注用户ID |
| followDate | DATETIME | 关注时间 |

#### 4.1.9 私信表(Chat)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| fromId | INT | 发送者ID |
| toId | INT | 接收者ID |
| content | VARCHAR | 消息内容 |
| isRead | INT | 是否已读 |
| createDate | DATETIME | 创建时间 |

---

## 5. 核心算法设计

### 5.1 用户推荐算法

```startuml
@startuml
start
:获取当前用户历史观看记录;
:分析用户偏好(分类、标签);
:计算视频相似度;

:基于协同过滤推荐;
:基于内容推荐;
:融合多种推荐结果;

:排序并返回TopN推荐;
stop
@enduml
```

### 5.2 视频热度计算算法

热度计算公式：
```
热度 = α × 播放数 + β × 点赞数 + γ × 评论数 + δ × 投币数 + ε × 收藏数 + ζ × 分享数
```

其中 α, β, γ, δ, ε, ζ 为权重系数。

### 5.3 评论树构建算法

```startuml
@startuml
start
:获取所有根评论(rootId=0);
:对每个根评论;

:递归加载子评论;
:构建评论树结构;

:按热度或时间排序;
:返回评论树;

stop
@enduml
```

---

## 6. 缓存设计

### 6.1 Redis数据结构设计

**字符串类型(String)**
- `user:{uid}` - 用户信息
- `video:{vid}` - 视频信息
- `jwt:{token}` - JWT令牌

**哈希类型(Hash)**
- `video_stats:{vid}` - 视频统计数据
- `user_stats:{uid}` - 用户统计数据

**集合类型(Set)**
- `video_status:{status}` - 各状态视频ID集合
- `user_love:{uid}` - 用户点赞的视频

**有序集合类型(Sorted Set)**
- `comment_video:{vid}` - 视频评论(按时间或热度排序)
- `favorite_video:{fid}` - 收藏夹中的视频(按收藏时间排序)
- `user_video_history:{uid}` - 用户观看历史(按时间排序)
- `hot_search` - 热搜榜单(按热度排序)

### 6.2 缓存更新策略

**写后更新(Write-Through)**
- 数据写入数据库后立即更新缓存

**写回(Write-Back)**
- 数据先写入缓存，异步更新到数据库

**过期策略**
- 设置合理的TTL(Time To Live)

### 6.3 缓存穿透防护

1. **布隆过滤器** - 过滤不存在的查询
2. **缓存空值** - 对查询不到的key也缓存

### 6.4 缓存雪崩防护

1. **随机过期时间** - 避免大量key同时过期
2. **多级缓存** - 本地缓存 + Redis缓存
3. **限流降级** - 超过阈值时返回默认值

---

## 7. 安全设计

### 7.1 认证机制

使用JWT(JSON Web Token)实现无状态认证。

```startuml
@startuml
start
:用户登录;
:验证用户名密码;
:生成JWT令牌;

:返回令牌给客户端;
:客户端存储令牌;

partition "后续请求" {
  :携带JWT令牌;
  :验证令牌有效性;
  if (令牌有效?) then (是)
    :解析用户信息;
    :允许访问;
  else (否)
    :返回401未授权;
  endif
}

stop
@enduml
```

### 7.2 权限控制

使用Spring Security实现细粒度的权限控制。

**权限等级：**
- ROLE_USER - 普通用户
- ROLE_ADMIN - 管理员
- ROLE_SUPER_ADMIN - 超级管理员

### 7.3 数据安全

1. **密码加密** - 使用BCrypt算法加密
2. **SQL注入防护** - 使用MyBatis Plus参数化查询
3. **XSS防护** - 对用户输入进行过滤
4. **CSRF防护** - 使用CSRF Token

### 7.4 文件上传安全

1. **文件类型校验** - 只允许指定类型的文件
2. **文件大小限制** - 限制单文件最大30MB
3. **文件名处理** - 防止路径遍历攻击
4. **病毒扫描** - 上传文件前进行扫描

---

## 8. 性能优化设计

### 8.1 数据库优化

1. **索引优化** - 为常用查询字段建立索引
2. **读写分离** - 主库写，从库读
3. **分库分表** - 数据量大时进行分片

### 8.2 缓存优化

1. **热点数据缓存** - 缓存高频访问的数据
2. **缓存预热** - 系统启动时加载热点数据
3. **缓存更新** - 使用消息队列异步更新

### 8.3 代码优化

1. **异步处理** - 耗时操作异步执行
2. **批量操作** - 数据库批量插入/更新
3. **连接池** - 数据库连接池、Redis连接池

### 8.4 前端优化

1. **CDN加速** - 静态资源使用CDN
2. **懒加载** - 图片、视频懒加载
3. **分页加载** - 列表分页加载，避免一次性加载过多数据
4. **请求合并** - 合并多个小请求

---

## 9. 异常处理设计

### 9.1 异常分类

**业务异常** - 用户操作不当导致的异常
**系统异常** - 系统内部错误
**网络异常** - 网络连接问题

### 9.2 异常处理流程

```startuml
@startuml
start
:捕获异常;
:记录异常日志;

if (是业务异常?) then (是)
  :返回友好提示信息;
  stop
endif

if (是系统异常?) then (是)
  :记录详细错误日志;
  :返回"系统错误，请稍后重试";
  :发送告警通知;
  stop
endif

:返回通用错误信息;
stop
@enduml
```

### 9.3 日志设计

**日志级别：**
- ERROR - 错误信息
- WARN - 警告信息
- INFO - 一般信息
- DEBUG - 调试信息

---

## 10. 接口规范

### 10.1 统一响应格式

```json
{
  "code": 200,
  "message": "成功",
  "data": {...}
}
```

**状态码定义：**
- 200 - 成功
- 400 - 请求参数错误
- 401 - 未授权
- 403 - 禁止访问
- 404 - 资源不存在
- 500 - 服务器错误

### 10.2 RESTful API设计规范

**URL命名：**
- 使用名词，不使用动词
- 使用复数形式
- 使用小写字母和连字符

**HTTP方法：**
- GET - 查询
- POST - 创建
- PUT - 更新
- DELETE - 删除

**示例：**
```
GET /video/123 - 获取视频
POST /video - 创建视频
PUT /video/123 - 更新视频
DELETE /video/123 - 删除视频
```

---

## 11. 部署设计

### 11.1 部署架构

```startuml
@startuml
node "负载均衡器" as LB

node "应用服务器1" as App1 {
  component [Nginx]
  component [Spring Boot]
}

node "应用服务器2" as App2 {
  component [Nginx]
  component [Spring Boot]
}

database "MySQL主库" as MySQL_M
database "MySQL从库" as MySQL_S

node "缓存服务器" as Redis {
  database [Redis]
}

node "搜索引擎" as ES {
  database [Elasticsearch]
}

node "对象存储" as OSS {
  cloud [阿里云OSS]
}

LB --> App1
LB --> App2

App1 --> MySQL_M
App2 --> MySQL_M
MySQL_M --> MySQL_S

App1 --> Redis
App2 --> Redis

App1 --> ES
App2 --> ES

App1 --> OSS
App2 --> OSS

@enduml
```

### 11.2 容器化部署

使用Docker容器化应用。

**Dockerfile示例：**
```dockerfile
FROM openjdk:8-jre
WORKDIR /app
COPY target/backend.jar app.jar
EXPOSE 7070
CMD ["java", "-jar", "app.jar"]
```

### 11.3 CI/CD流程

```startuml
@startuml
start
:开发者提交代码;
:Git推送触发CI;

:运行单元测试;
if (测试失败?) then (是)
  :通知开发者;
  stop
endif

:构建Docker镜像;
:推送到镜像仓库;

:部署到测试环境;
:运行集成测试;

if (测试通过?) then (否)
  :回滚;
  stop
endif

:部署到生产环境;
:健康检查;

stop
@enduml
```

---

## 12. 监控与运维

### 12.1 监控指标

1. **系统指标** - CPU、内存、磁盘、网络
2. **应用指标** - QPS、响应时间、错误率
3. **业务指标** - DAU、视频播放量、用户活跃度

### 12.2 告警策略

- CPU使用率 > 80% - 警告
- 内存使用率 > 85% - 告警
- 错误率 > 1% - 告警
- 响应时间 > 3s - 告警

### 12.3 日志收集

使用ELK(Elasticsearch + Logstash + Kibana)进行日志收集和分析。

---

## 13. 测试设计

### 13.1 单元测试

使用JUnit进行单元测试，覆盖率要求 > 80%。

### 13.2 集成测试

测试各模块之间的交互。

### 13.3 性能测试

使用JMeter进行压力测试。

### 13.4 安全测试

进行SQL注入、XSS、CSRF等安全测试。

---

## 14. 开发规范

### 14.1 编码规范

1. **命名规范**
   - 类名：大驼峰
   - 方法名、变量名：小驼峰
   - 常量：全大写，下划线分隔

2. **注释规范**
   - 类和公共方法必须有JavaDoc注释
   - 复杂逻辑必须添加注释

3. **格式规范**
   - 使用统一的代码格式化工具
   - 缩进使用4个空格

### 14.2 Git分支管理

```
master - 主分支，保持稳定
develop - 开发分支
feature/* - 功能分支
hotfix/* - 热修复分支
```

### 14.3 代码审查

所有代码必须经过代码审查后才能合并到主分支。

---

## 15. 附录

### 15.1 术语表

- **UP主** - 内容创作者
- **弹幕** - 实时评论
- **币/硬币** - 虚拟货币
- **经验值** - 用户等级相关数值

### 15.2 参考资料

- Spring Boot官方文档：https://spring.io/projects/spring-boot
- MyBatis Plus官方文档：https://baomidou.com/
- Vue.js官方文档：https://cn.vuejs.org/
- Redis官方文档：https://redis.io/docs/
- Elasticsearch官方文档：https://www.elastic.co/guide/

### 15.3 项目结构

```
blbl/
├── teriteri-backend-main/     # 后端项目
│   ├── src/main/java/
│   │   └── com/teriteri/backend/
│   │       ├── controller/    # 控制器
│   │       ├── service/       # 服务层
│   │       ├── mapper/        # 数据访问
│   │       ├── pojo/          # 实体类
│   │       ├── config/        # 配置类
│   │       └── utils/         # 工具类
│   └── src/main/resources/
│       └── application.yml    # 配置文件
├── teriteri-client-main/      # 前端客户端
│   └── src/
│       ├── components/        # 组件
│       ├── views/            # 页面
│       └── router/           # 路由
└── teriteri-admin-main/      # 管理后台
```

---

## 16. 总结

本文档详细描述了BLBL视频分享平台的详细设计，包括系统架构、模块设计、数据库设计、接口设计、算法设计等内容。本文档为开发人员提供了详细的技术指导，确保项目的顺利开发和质量保证。

在后续开发过程中，应根据实际情况对本文档进行更新和完善。

---

**文档结束**

