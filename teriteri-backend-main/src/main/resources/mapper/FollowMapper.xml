<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.teriteri.backend.mapper.FollowMapper">

    <!-- 插入关注关系 -->
    <insert id="insert" parameterType="com.teriteri.backend.pojo.Follow" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO follow (follower_id, following_id, create_date, is_deleted)
        VALUES (#{followerId}, #{followingId}, #{createDate}, #{isDeleted})
    </insert>

    <!-- 根据ID更新关注关系 -->
    <update id="updateById" parameterType="com.teriteri.backend.pojo.Follow">
        UPDATE follow 
        SET is_deleted = #{isDeleted}, delete_date = #{deleteDate}
        WHERE id = #{id}
    </update>

    <!-- 根据关注者和被关注者查找关注关系 -->
    <select id="findByFollowerAndFollowing" resultType="com.teriteri.backend.pojo.Follow">
        SELECT id, follower_id, following_id, create_date, is_deleted, delete_date
        FROM follow 
        WHERE follower_id = #{followerId} AND following_id = #{followingId}
    </select>

    <!-- 获取用户的关注列表 -->
    <select id="getFollowList" resultType="com.teriteri.backend.pojo.dto.UserDTO">
        SELECT u.uid, u.username, u.nickname, u.avatar, u.gender, u.description, 
               u.exp, u.coin, u.vip, u.state, u.role, u.auth, u.auth_msg, u.create_date,
               f.create_date as follow_date
        FROM follow f
        INNER JOIN user u ON f.following_id = u.uid
        WHERE f.follower_id = #{uid} AND f.is_deleted = 0 AND u.state != 2
        ORDER BY f.create_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 获取用户的粉丝列表 -->
    <select id="getFansList" resultType="com.teriteri.backend.pojo.dto.UserDTO">
        SELECT u.uid, u.username, u.nickname, u.avatar, u.gender, u.description, 
               u.exp, u.coin, u.vip, u.state, u.role, u.auth, u.auth_msg, u.create_date,
               f.create_date as follow_date
        FROM follow f
        INNER JOIN user u ON f.follower_id = u.uid
        WHERE f.following_id = #{uid} AND f.is_deleted = 0 AND u.state != 2
        ORDER BY f.create_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 获取用户关注数量 -->
    <select id="getFollowCount" resultType="int">
        SELECT COUNT(*)
        FROM follow f
        INNER JOIN user u ON f.following_id = u.uid
        WHERE f.follower_id = #{uid} AND f.is_deleted = 0 AND u.state != 2
    </select>

    <!-- 获取用户粉丝数量 -->
    <select id="getFansCount" resultType="int">
        SELECT COUNT(*)
        FROM follow f
        INNER JOIN user u ON f.follower_id = u.uid
        WHERE f.following_id = #{uid} AND f.is_deleted = 0 AND u.state != 2
    </select>

</mapper>
